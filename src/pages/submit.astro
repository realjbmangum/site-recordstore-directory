---
import BaseLayout from '../layouts/BaseLayout.astro';
import { US_STATES } from '../lib/utils';
import genres from '../data/genres.json';

const states = Object.entries(US_STATES).map(([abbr, name]) => ({ abbr, name }));
---

<BaseLayout
  title="Submit a Store"
  description="Know a great record store? Submit it to our directory and help fellow vinyl enthusiasts discover new places to explore."
>
  <div class="container-page py-8 md:py-12">
    <div class="max-w-2xl mx-auto">
      <h1 class="font-display text-3xl md:text-4xl font-bold text-ink-900 mb-4">
        Submit a Store
      </h1>
      <p class="text-ink-600 mb-8">
        Know a great record store that's not in our directory? Help fellow vinyl enthusiasts discover it by submitting the details below.
      </p>

      <form
        id="submit-form"
        class="bg-white rounded-xl border border-ink-200 p-6 md:p-8"
      >
        <!-- Store Name -->
        <div class="mb-6">
          <label for="store_name" class="block text-sm font-medium text-ink-700 mb-2">
            Store Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="store_name"
            name="store_name"
            required
            class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
            placeholder="e.g., Vinyl Paradise Records"
          />
        </div>

        <!-- Location -->
        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div>
            <label for="city" class="block text-sm font-medium text-ink-700 mb-2">
              City <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="city"
              name="city"
              required
              class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
              placeholder="e.g., Austin"
            />
          </div>
          <div>
            <label for="state" class="block text-sm font-medium text-ink-700 mb-2">
              State <span class="text-red-500">*</span>
            </label>
            <select
              id="state"
              name="state"
              required
              class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
            >
              <option value="">Select a state</option>
              {states.map(({ abbr, name }) => (
                <option value={name}>{name}</option>
              ))}
            </select>
          </div>
        </div>

        <!-- Address -->
        <div class="mb-6">
          <label for="street_address" class="block text-sm font-medium text-ink-700 mb-2">
            Street Address
          </label>
          <input
            type="text"
            id="street_address"
            name="street_address"
            class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
            placeholder="e.g., 123 Main Street"
          />
        </div>

        <!-- Contact Info -->
        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div>
            <label for="website" class="block text-sm font-medium text-ink-700 mb-2">
              Website
            </label>
            <input
              type="url"
              id="website"
              name="website"
              class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
              placeholder="https://..."
            />
          </div>
          <div>
            <label for="phone" class="block text-sm font-medium text-ink-700 mb-2">
              Phone
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
              placeholder="(555) 123-4567"
            />
          </div>
        </div>

        <!-- Genres -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-ink-700 mb-2">
            Genres (select all that apply)
          </label>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            {genres.map((genre) => (
              <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-ink-50 cursor-pointer">
                <input
                  type="checkbox"
                  name="genres"
                  value={genre.id}
                  class="w-4 h-4 text-groove-500 border-ink-300 rounded focus:ring-groove-500"
                />
                <span class="text-sm text-ink-700">{genre.label}</span>
              </label>
            ))}
          </div>
        </div>

        <!-- Description -->
        <div class="mb-6">
          <label for="description" class="block text-sm font-medium text-ink-700 mb-2">
            Description
          </label>
          <textarea
            id="description"
            name="description"
            rows="4"
            class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
            placeholder="Tell us what makes this store special..."
          ></textarea>
        </div>

        <!-- Your Info -->
        <div class="border-t border-ink-200 pt-6 mb-6">
          <h2 class="font-display text-lg font-semibold text-ink-900 mb-4">Your Information</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="contact_name" class="block text-sm font-medium text-ink-700 mb-2">
                Your Name
              </label>
              <input
                type="text"
                id="contact_name"
                name="contact_name"
                class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
              />
            </div>
            <div>
              <label for="contact_email" class="block text-sm font-medium text-ink-700 mb-2">
                Your Email <span class="text-red-500">*</span>
              </label>
              <input
                type="email"
                id="contact_email"
                name="contact_email"
                required
                class="w-full px-4 py-3 rounded-lg border border-ink-300 focus:outline-none focus:ring-2 focus:ring-groove-500 focus:border-transparent"
              />
            </div>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn-primary w-full justify-center py-4">
          Submit Store
        </button>

        <!-- Success/Error Messages -->
        <div id="form-message" class="mt-4 hidden"></div>
      </form>
    </div>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById('submit-form') as HTMLFormElement;
  const messageDiv = document.getElementById('form-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const genres = formData.getAll('genres');

    const data = {
      store_name: formData.get('store_name'),
      city: formData.get('city'),
      state: formData.get('state'),
      street_address: formData.get('street_address'),
      website: formData.get('website'),
      phone: formData.get('phone'),
      genres: genres,
      description: formData.get('description'),
      contact_name: formData.get('contact_name'),
      contact_email: formData.get('contact_email'),
    };

    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;

    try {
      // Submit to Web3Forms
      const web3formsKey = import.meta.env.PUBLIC_WEB3FORMS_KEY;
      if (web3formsKey) {
        await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            access_key: web3formsKey,
            subject: `New Store Submission: ${data.store_name}`,
            from_name: 'RecordStores',
            ...data,
            genres: genres.join(', '),
          }),
        });
      }

      // Show success
      messageDiv.className = 'mt-4 p-4 bg-green-50 text-green-700 rounded-lg';
      messageDiv.textContent = 'Thank you! Your submission has been received and will be reviewed shortly.';
      messageDiv.classList.remove('hidden');
      form.reset();
    } catch (error) {
      messageDiv.className = 'mt-4 p-4 bg-red-50 text-red-700 rounded-lg';
      messageDiv.textContent = 'Something went wrong. Please try again or email us directly.';
      messageDiv.classList.remove('hidden');
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
</script>
