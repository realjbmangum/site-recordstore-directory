---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SearchBar from '../../components/SearchBar.astro';
import StoreGrid from '../../components/StoreGrid.astro';
import StoreMap from '../../components/StoreMap.astro';
import { getStores, getStatesWithCounts } from '../../lib/supabase';
import { stateToSlug } from '../../lib/utils';
import genres from '../../data/genres.json';

// Get query params
const url = Astro.url;
const searchQuery = url.searchParams.get('q') || '';
const selectedGenre = url.searchParams.get('genre') || '';
const selectedState = url.searchParams.get('state') || '';

// Fetch stores with filters
const stores = await getStores({
  genre: selectedGenre || undefined,
  state: selectedState || undefined,
  limit: 48,
});

// Get states for filter
const statesWithCounts = await getStatesWithCounts();

// Filter by search query on client-fetched data if needed
const filteredStores = searchQuery
  ? stores.filter(
      (store) =>
        store.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        store.city.toLowerCase().includes(searchQuery.toLowerCase()) ||
        store.state.toLowerCase().includes(searchQuery.toLowerCase())
    )
  : stores;

const title = selectedState
  ? `Record Stores in ${selectedState}`
  : selectedGenre
  ? `${genres.find((g) => g.id === selectedGenre)?.label || selectedGenre} Record Stores`
  : 'Browse Record Stores';
---

<BaseLayout
  title={title}
  description={`Find independent record stores${selectedState ? ` in ${selectedState}` : ''}. Browse ${filteredStores.length} vinyl shops with detailed information about genres, features, and locations.`}
>
  <div class="container-page py-8 md:py-12">
    <!-- Header -->
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="font-display text-3xl md:text-4xl font-bold text-ink-900 mb-2">
          {title}
        </h1>
        <p class="text-ink-600">
          {filteredStores.length} stores found
        </p>
      </div>

      <!-- View Toggle -->
      <div class="flex items-center gap-1 bg-ink-100 p-1 rounded-lg">
        <button
          id="grid-view-btn"
          class="view-toggle-btn active flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-colors"
          aria-label="Grid view"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
          <span class="hidden sm:inline">Grid</span>
        </button>
        <button
          id="map-view-btn"
          class="view-toggle-btn flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-colors"
          aria-label="Map view"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
          <span class="hidden sm:inline">Map</span>
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl border border-ink-200 p-4 md:p-6 mb-8">
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Search -->
        <div>
          <label class="block text-sm font-medium text-ink-700 mb-2">Search</label>
          <SearchBar placeholder="Store name, city..." />
        </div>

        <!-- State Filter -->
        <div>
          <label class="block text-sm font-medium text-ink-700 mb-2">State</label>
          <select
            id="state-filter"
            class="w-full h-12 px-4 rounded-lg border border-ink-300 bg-white text-ink-900 focus:outline-none focus:ring-2 focus:ring-groove-500"
          >
            <option value="">All States</option>
            {statesWithCounts.map(({ state, count }) => (
              <option value={state} selected={selectedState === state}>
                {state} ({count})
              </option>
            ))}
          </select>
        </div>

        <!-- Genre Filter -->
        <div>
          <label class="block text-sm font-medium text-ink-700 mb-2">Genre</label>
          <select
            id="genre-filter"
            class="w-full h-12 px-4 rounded-lg border border-ink-300 bg-white text-ink-900 focus:outline-none focus:ring-2 focus:ring-groove-500"
          >
            <option value="">All Genres</option>
            {genres.map((genre) => (
              <option value={genre.id} selected={selectedGenre === genre.id}>
                {genre.label}
              </option>
            ))}
          </select>
        </div>
      </div>
    </div>

    <!-- Results - Grid View -->
    <div id="grid-view">
      <StoreGrid
        stores={filteredStores}
        emptyMessage="No stores match your filters. Try adjusting your search."
      />
    </div>

    <!-- Results - Map View -->
    <div id="map-view" class="hidden">
      <StoreMap stores={filteredStores} height="600px" />
    </div>

    <!-- Browse by State -->
    {statesWithCounts.length > 0 && !selectedState && (
      <div class="mt-12">
        <h2 class="font-display text-xl font-bold text-ink-900 mb-4">
          Browse by State
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
          {statesWithCounts.map(({ state, count }) => (
            <a
              href={`/stores/${stateToSlug(state)}`}
              class="px-3 py-2 text-sm bg-ink-50 rounded-lg hover:bg-groove-50 hover:text-groove-700 transition-colors flex justify-between"
            >
              <span>{state}</span>
              <span class="text-ink-400">{count}</span>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .view-toggle-btn {
    color: #5a554f;
  }
  .view-toggle-btn:hover {
    color: #1a1918;
  }
  .view-toggle-btn.active {
    background: white;
    color: #1a1918;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
</style>

<script>
  const stateFilter = document.getElementById('state-filter') as HTMLSelectElement;
  const genreFilter = document.getElementById('genre-filter') as HTMLSelectElement;

  function updateFilters() {
    const url = new URL(window.location.href);

    if (stateFilter.value) {
      url.searchParams.set('state', stateFilter.value);
    } else {
      url.searchParams.delete('state');
    }

    if (genreFilter.value) {
      url.searchParams.set('genre', genreFilter.value);
    } else {
      url.searchParams.delete('genre');
    }

    window.location.href = url.toString();
  }

  stateFilter?.addEventListener('change', updateFilters);
  genreFilter?.addEventListener('change', updateFilters);

  // View toggle functionality
  const gridViewBtn = document.getElementById('grid-view-btn');
  const mapViewBtn = document.getElementById('map-view-btn');
  const gridView = document.getElementById('grid-view');
  const mapView = document.getElementById('map-view');

  function setView(view: 'grid' | 'map') {
    if (view === 'grid') {
      gridView?.classList.remove('hidden');
      mapView?.classList.add('hidden');
      gridViewBtn?.classList.add('active');
      mapViewBtn?.classList.remove('active');
      localStorage.setItem('stores-view', 'grid');
    } else {
      gridView?.classList.add('hidden');
      mapView?.classList.remove('hidden');
      gridViewBtn?.classList.remove('active');
      mapViewBtn?.classList.add('active');
      localStorage.setItem('stores-view', 'map');
    }
  }

  gridViewBtn?.addEventListener('click', () => setView('grid'));
  mapViewBtn?.addEventListener('click', () => setView('map'));

  // Restore saved view preference
  const savedView = localStorage.getItem('stores-view') as 'grid' | 'map' | null;
  if (savedView === 'map') {
    setView('map');
  }
</script>
